# AgentGate Monorepo Verification Gate Plan
# This defines what MUST pass for any code change to be accepted

version: "1"

environment:
  runtime: node
  runtimeVersion: "20"
  setupCommands:
    - name: install
      command: pnpm install

# Level 0: Contract validation (automatic)
contracts:
  forbiddenPatterns:
    - "**/.env"
    - "**/.env.*"
    - "**/secrets/**"
    - "**/*.pem"
    - "**/*.key"
    - "**/credentials.json"
    - "**/service-account*.json"

# Level 1: Test commands (MUST ALL PASS)
tests:
  - name: shared-typecheck
    command: pnpm --filter @agentgate/shared typecheck
    description: Shared types compilation

  - name: server-typecheck
    command: pnpm --filter @agentgate/server typecheck
    description: Server TypeScript compilation with strict mode

  - name: dashboard-typecheck
    command: pnpm --filter @agentgate/dashboard typecheck
    description: Dashboard TypeScript compilation

  - name: server-lint
    command: pnpm --filter @agentgate/server lint
    description: Server ESLint code quality checks

  - name: dashboard-lint
    command: pnpm --filter @agentgate/dashboard lint
    description: Dashboard ESLint code quality checks

  - name: server-tests
    command: pnpm --filter @agentgate/server test
    description: Server unit and integration tests
    timeout: 300  # 5 minutes

  - name: build-all
    command: pnpm build
    description: Build all packages

# Level 2: Blackbox tests (functional verification)
blackbox:
  - name: cli-help
    command: node packages/server/dist/index.js --help
    expectExitCode: 0
    description: CLI starts and shows help

  - name: health-endpoint
    setup: |
      node packages/server/dist/index.js serve --port 13001 &
      sleep 2
    command: curl -s http://localhost:13001/health
    expectContains: '"status":"ok"'
    teardown: pkill -f "serve --port 13001" || true
    description: HTTP server health check works

  - name: dashboard-build
    command: test -d packages/dashboard/dist
    expectExitCode: 0
    description: Dashboard build output exists

# Level 3: Sanity checks (structural validation)
sanity:
  requiredFiles:
    - path: "packages/server/src/**/*.ts"
      description: Server source files exist
    - path: "packages/dashboard/src/**/*.ts"
      description: Dashboard source files exist
    - path: "packages/shared/src/**/*.ts"
      description: Shared types exist

  # Require tests for new source files
  testCoverage:
    enabled: true
    rules:
      - pattern: "packages/server/src/server/websocket/*.ts"
        requiresTest: "packages/server/test/websocket*.test.ts"
      - pattern: "packages/server/src/server/routes/*.ts"
        requiresTest: "packages/server/test/routes*.test.ts OR packages/server/test/integration/*.test.ts"
      - pattern: "packages/server/src/orchestrator/*.ts"
        requiresTest: "packages/server/test/orchestrator*.test.ts OR packages/server/test/*.test.ts"

# Execution policy
execution:
  networkAllowed: false
  maxRuntimeSeconds: 600
  disallowedCommands:
    - "rm -rf /"
    - "sudo rm -rf"
